name: Ubuntu-RDP
on:
  workflow_dispatch:

jobs:
  ubuntu-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Desktop and XRDP
        run: |
          sudo apt-get update -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y xfce4 xfce4-goodies xrdp dbus-x11
          sudo systemctl enable --now xrdp

          # Create fixed user RDP with fixed password
          if ! id -u RDP >/dev/null 2>&1; then
            sudo useradd -m -s /bin/bash RDP
          fi
          echo "RDP:@ShowOff67" | sudo chpasswd
          sudo usermod -aG sudo,RDP xrdp || true
          # Ensure RDP user uses XFCE session
          echo "startxfce4" | sudo tee /home/RDP/.xsession >/dev/null
          sudo chown RDP:RDP /home/RDP/.xsession

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sudo sh

      - name: Start Tailscale (automatic if secret provided)
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          if [ -n "$TAILSCALE_AUTH_KEY" ]; then
            sudo tailscale up --authkey="$TAILSCALE_AUTH_KEY" --hostname=ubuntu-runner-${{ github.run_id }} || true
          else
            echo "No TAILSCALE_AUTH_KEY provided -> tailscale up will require manual login."
            sudo tailscale up --hostname=ubuntu-runner-${{ github.run_id }} || true
          fi
          # print IPv4 tailscale address
          echo "TAILSCALE_IP=$(sudo tailscale ip -4)" >> $GITHUB_ENV || true

      - name: Show RDP Info
        run: |
          echo "=== Ubuntu RDP ==="
          echo "Username: RDP"
          echo "Password: @ShowOff67"
          echo "Tailscale IP: $(sudo tailscale ip -4 || echo 'not-assigned')"
          echo "Connect from Windows using Remote Desktop (mstsc) -> TailscaleIP:3389"
          echo "=================="
          # keep job alive while you connect (cancel workflow when done)
          while true; do sleep 300; done
